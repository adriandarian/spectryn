name: ðŸš€ Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (skip actual publishing)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write
  id-token: write

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================================
  # Validation & Preparation
  # ============================================================================
  validate:
    name: ðŸ” Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      prerelease: ${{ steps.version.outputs.prerelease }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“‹ Determine Version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

          # Check if prerelease
          if [[ "$VERSION" == *"-"* ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

          echo "ðŸ“¦ Version: $VERSION"

      - name: âœ… Validate Version Format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-prerelease"
            exit 1
          fi

      - name: ðŸ” Check CHANGELOG Entry
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! grep -q "\[$VERSION\]" CHANGELOG.md; then
            echo "âš ï¸ Warning: No CHANGELOG entry found for version $VERSION"
            echo "Consider adding release notes to CHANGELOG.md"
          fi

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Install and Validate Package
        run: |
          pip install -e ".[dev]"
          python -c "import spectryn; print(f'Package version: {spectryn.__version__}')"

      - name: ðŸ§ª Run Tests
        run: pytest tests/ -v --tb=short

  # ============================================================================
  # Build Release Assets
  # ============================================================================
  build:
    name: ðŸ“¦ Build Assets
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Install Build Tools
        run: pip install build twine

      - name: ðŸ”§ Update Version in pyproject.toml
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          sed -i "s/^version = .*/version = \"$VERSION\"/" pyproject.toml
          cat pyproject.toml | grep "^version"

      - name: ðŸ—ï¸ Build Python Package
        run: python -m build

      - name: âœ… Verify Package
        run: twine check dist/*.whl dist/*.tar.gz

      - name: ðŸ“¤ Upload Python Dist
        uses: actions/upload-artifact@v4
        with:
          name: python-dist
          path: dist/

      - name: ðŸ“¤ Upload Shell Completions
        uses: actions/upload-artifact@v4
        with:
          name: completions
          path: packaging/completions/

  # ============================================================================
  # Create GitHub Release
  # ============================================================================
  github-release:
    name: ðŸ·ï¸ GitHub Release
    needs: [validate, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: ðŸ“ Generate Release Notes
        id: release_notes
        run: |
          VERSION="${{ needs.validate.outputs.version }}"

          # Extract changelog section for this version
          NOTES=$(awk "/## \[$VERSION\]/,/## \[/{if(/## \[/ && !/## \[$VERSION\]/)exit; print}" CHANGELOG.md | tail -n +2)

          if [ -z "$NOTES" ]; then
            NOTES="Release $VERSION"
          fi

          # Get previous tag for changelog link
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          # Generate checksums
          CHECKSUMS=$(cd artifacts && find . -type f -name "*.whl" -o -name "*.tar.gz" -o -name "*.vsix" 2>/dev/null | xargs sha256sum 2>/dev/null | sed 's/\.\///' || echo "See individual asset files")

          # Create release notes file
          cat > release_notes.md << EOF
          # ðŸŽ‰ Spectryn $VERSION

          $NOTES

          ---

          ## ðŸš€ Quick Start

          \`\`\`bash
          # Install
          pip install spectryn==$VERSION

          # Validate your spec
          spectryn validate --markdown my-spec.md

          # Preview sync (dry run)
          spectryn sync --markdown my-spec.md --tracker jira

          # Execute sync
          spectryn sync --markdown my-spec.md --tracker jira --execute
          \`\`\`

          ---

          ## ðŸ“¦ Installation

          | Method | Command |
          |--------|---------|
          | **pip** | \`pip install spectryn==$VERSION\` |
          | **pipx** | \`pipx install spectryn==$VERSION\` |
          | **Docker** | \`docker pull adriandarian/spectryn:$VERSION\` |
          | **Homebrew** | \`brew install adriandarian/spectryn/spectryn\` |

          ### VS Code Extension

          Download the \`.vsix\` file from the assets below and install:
          \`\`\`bash
          code --install-extension spectryn-$VERSION.vsix
          \`\`\`

          ### From Source
          \`\`\`bash
          pip install git+https://github.com/adriandarian/spectryn.git@v$VERSION
          \`\`\`

          ---

          ## ðŸ“š Documentation

          - [Getting Started](https://spectryn.dev/guide/getting-started)
          - [CLI Reference](https://spectryn.dev/reference/cli)
          - [Configuration](https://spectryn.dev/guide/configuration)

          ---

          ## ðŸ” Checksums

          \`\`\`
          $CHECKSUMS
          \`\`\`

          ---

          **Full Changelog**: https://github.com/adriandarian/spectryn/compare/${PREV_TAG:-v0.0.0}...v$VERSION
          EOF

          echo "Generated release notes"

      - name: ðŸ·ï¸ Create Tag (if workflow_dispatch)
        if: github.event_name == 'workflow_dispatch' && !inputs.dry_run
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ needs.validate.outputs.tag }}" -m "Release ${{ needs.validate.outputs.version }}"
          git push origin "${{ needs.validate.outputs.tag }}"

      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: ${{ !inputs.dry_run }}
        with:
          tag_name: ${{ needs.validate.outputs.tag }}
          name: "Spectra ${{ needs.validate.outputs.version }}"
          body_path: release_notes.md
          draft: false
          prerelease: ${{ needs.validate.outputs.prerelease }}
          files: |
            artifacts/python-dist/*
            artifacts/completions/*
            artifacts/vscode-extension/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Publish Python Package to PyPI
  # ============================================================================
  publish-pypi:
    name: ðŸ Publish to PyPI
    needs: [validate, build, github-release]
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/project/spectryn/
    steps:
      - name: ðŸ“¥ Download Python Dist
        uses: actions/download-artifact@v4
        with:
          name: python-dist
          path: dist/

      - name: ðŸš€ Publish to PyPI
        if: ${{ !inputs.dry_run }}
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          # Uses OIDC trusted publishing - configure in PyPI project settings
          # No password needed!
          skip-existing: true

  # ============================================================================
  # Publish Docker Image
  # ============================================================================
  publish-docker:
    name: ðŸ³ Publish Docker Image
    needs: [validate, github-release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ” Login to Docker Hub
        if: ${{ !inputs.dry_run }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ðŸ” Login to GitHub Container Registry
        if: ${{ !inputs.dry_run }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            adriandarian/spectryn
            ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.validate.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.validate.outputs.version }}
            type=semver,pattern={{major}},value=${{ needs.validate.outputs.version }}
            type=raw,value=latest,enable=${{ needs.validate.outputs.prerelease == 'false' }}

      - name: ðŸ—ï¸ Build and Push
        uses: docker/build-push-action@v5
        if: ${{ !inputs.dry_run }}
        with:
          context: .
          file: packaging/docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ============================================================================
  # Publish VS Code Extension
  # ============================================================================
  publish-vscode:
    name: ðŸ†š Publish VS Code Extension
    needs: [validate, github-release]
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: integrations/vscode
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ”§ Update Version
        run: npm version ${{ needs.validate.outputs.version }} --no-git-tag-version

      - name: ðŸ—ï¸ Build Extension
        run: npm run compile

      - name: ðŸ“¦ Package Extension
        run: npx vsce package

      - name: ðŸš€ Publish to VS Code Marketplace
        if: ${{ !inputs.dry_run }}
        run: npx vsce publish -p ${{ secrets.VSCE_PAT }}
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        continue-on-error: true  # Will fail gracefully if token not set

      - name: ðŸš€ Publish to Open VSX
        if: ${{ !inputs.dry_run }}
        run: npx ovsx publish -p ${{ secrets.OVSX_PAT }}
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
        continue-on-error: true  # Will fail gracefully if token not set

      - name: ðŸ“¤ Upload Extension
        uses: actions/upload-artifact@v4
        with:
          name: vscode-extension
          path: integrations/vscode/*.vsix

  # ============================================================================
  # Publish Homebrew Formula
  # ============================================================================
  publish-homebrew:
    name: ðŸº Update Homebrew Formula
    needs: [validate, publish-pypi]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ“ Update Formula
        run: |
          VERSION="${{ needs.validate.outputs.version }}"

          # Download the release tarball to get SHA256
          curl -sL "https://github.com/adriandarian/spectryn/archive/refs/tags/v${VERSION}.tar.gz" -o spectryn.tar.gz
          SHA256=$(sha256sum spectryn.tar.gz | cut -d' ' -f1)

          # Update formula
          sed -i "s|url \".*\"|url \"https://github.com/adriandarian/spectryn/archive/refs/tags/v${VERSION}.tar.gz\"|" packaging/packages/homebrew/spectryn.rb
          sed -i "s|sha256 \".*\"|sha256 \"${SHA256}\"|" packaging/packages/homebrew/spectryn.rb
          sed -i "s|version \".*\"|version \"${VERSION}\"|" packaging/packages/homebrew/spectryn.rb

          echo "Updated formula with version $VERSION and SHA256 $SHA256"

      - name: ðŸš€ Commit Updated Formula
        if: ${{ !inputs.dry_run }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packaging/packages/homebrew/spectryn.rb
          git commit -m "chore: update Homebrew formula to ${{ needs.validate.outputs.version }}" || echo "No changes to commit"
          git push origin main

  # ============================================================================
  # Chocolatey Package (Windows)
  # ============================================================================
  publish-chocolatey:
    name: ðŸ« Publish to Chocolatey
    needs: [validate, github-release]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ”§ Update Package Version
        shell: pwsh
        run: |
          $version = "${{ needs.validate.outputs.version }}"
          $nuspec = "packaging/packages/chocolatey/spectryn.nuspec"

          # Update version in nuspec
          (Get-Content $nuspec) -replace '<version>.*</version>', "<version>$version</version>" | Set-Content $nuspec

          # Update download URL
          $url = "https://github.com/adriandarian/spectryn/releases/download/v$version/spectryn-$version.tar.gz"
          (Get-Content "packaging/packages/chocolatey/tools/chocolateyinstall.ps1") -replace '\$url = .*', "`$url = '$url'" | Set-Content "packaging/packages/chocolatey/tools/chocolateyinstall.ps1"

      - name: ðŸ“¦ Pack Chocolatey Package
        shell: pwsh
        run: |
          cd packaging/packages/chocolatey
          choco pack

      - name: ðŸš€ Push to Chocolatey
        if: ${{ !inputs.dry_run }}
        shell: pwsh
        run: |
          cd packaging/packages/chocolatey
          choco push spectryn.${{ needs.validate.outputs.version }}.nupkg --source https://push.chocolatey.org/ --api-key ${{ secrets.CHOCOLATEY_API_KEY }}
        continue-on-error: true

  # ============================================================================
  # Debian Package
  # ============================================================================
  build-debian:
    name: ðŸ§ Build Debian Package
    needs: [validate, github-release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev fakeroot
          pip install build

      - name: ðŸ—ï¸ Build Python Package
        run: python -m build

      - name: ðŸ“¦ Create Debian Package Structure
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          PKG_DIR="spectryn_${VERSION}_all"

          mkdir -p $PKG_DIR/DEBIAN
          mkdir -p $PKG_DIR/usr/local/bin
          mkdir -p $PKG_DIR/usr/local/lib/python3/dist-packages

          # Control file
          cat > $PKG_DIR/DEBIAN/control << EOF
          Package: spectryn
          Version: $VERSION
          Section: utils
          Priority: optional
          Architecture: all
          Depends: python3 (>= 3.11), python3-pip
          Maintainer: Adrian Darian <adrian.the.hactus@gmail.com>
          Description: Sync markdown specifications with issue trackers
           Spectra is a production-grade CLI tool for synchronizing
           markdown specifications with issue trackers like Jira,
           GitHub Issues, Azure DevOps, and Linear.
          Homepage: https://github.com/adriandarian/spectryn
          EOF

          # Post-install script
          cat > $PKG_DIR/DEBIAN/postinst << 'POSTINST'
          #!/bin/bash
          pip3 install spectryn==$VERSION || true
          POSTINST
          chmod 755 $PKG_DIR/DEBIAN/postinst

          # Build the package
          dpkg-deb --build $PKG_DIR

      - name: ðŸ“¤ Upload Debian Package
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: "*.deb"

  # ============================================================================
  # RPM Package
  # ============================================================================
  build-rpm:
    name: ðŸŽ© Build RPM Package
    needs: [validate, github-release]
    runs-on: ubuntu-latest
    container: fedora:latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ“¦ Install Build Dependencies
        run: |
          dnf install -y rpm-build python3-pip python3-devel

      - name: ðŸ—ï¸ Build RPM Package
        run: |
          VERSION="${{ needs.validate.outputs.version }}"

          # Create RPM build structure
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}

          # Copy spec file
          cp packaging/packages/linux/spectryn.spec ~/rpmbuild/SPECS/

          # Update version in spec
          sed -i "s/^Version:.*/Version: $VERSION/" ~/rpmbuild/SPECS/spectryn.spec

          # Download source
          curl -sL "https://github.com/adriandarian/spectryn/archive/refs/tags/v${VERSION}.tar.gz" -o ~/rpmbuild/SOURCES/spectryn-${VERSION}.tar.gz || \
            tar czf ~/rpmbuild/SOURCES/spectryn-${VERSION}.tar.gz .

          # Build RPM
          rpmbuild -ba ~/rpmbuild/SPECS/spectryn.spec || echo "RPM build skipped - source not available yet"

      - name: ðŸ“¤ Upload RPM Package
        uses: actions/upload-artifact@v4
        with:
          name: rpm-package
          path: ~/rpmbuild/RPMS/**/*.rpm
        continue-on-error: true

  # ============================================================================
  # Summary
  # ============================================================================
  release-summary:
    name: ðŸ“‹ Release Summary
    needs: [validate, github-release, publish-pypi, publish-docker, publish-vscode, publish-homebrew, publish-chocolatey, build-debian, build-rpm]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“‹ Summary
        run: |
          echo "## ðŸš€ Release Summary for v${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | ${{ needs.github-release.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PyPI | ${{ needs.publish-pypi.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Hub | ${{ needs.publish-docker.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| VS Code Extension | ${{ needs.publish-vscode.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Homebrew | ${{ needs.publish-homebrew.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Chocolatey | ${{ needs.publish-chocolatey.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Debian Package | ${{ needs.build-debian.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| RPM Package | ${{ needs.build-rpm.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/adriandarian/spectryn/releases/tag/v${{ needs.validate.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "- [PyPI Package](https://pypi.org/project/spectryn/${{ needs.validate.outputs.version }}/)" >> $GITHUB_STEP_SUMMARY
          echo "- [Docker Hub](https://hub.docker.com/r/adriandarian/spectryn)" >> $GITHUB_STEP_SUMMARY


