name: üîç Pull Request

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [main]

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  PYTHON_VERSION_PRIMARY: '3.11'
  NODE_VERSION: '20'

jobs:
  # ============================================================================
  # Quick Checks (Fast Feedback)
  # ============================================================================
  quick-checks:
    name: ‚ö° Quick Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_PRIMARY }}
          cache: 'pip'

      - name: üì¶ Install Dependencies
        run: pip install -e ".[dev]"

      - name: üîç Check for Debug Code
        run: |
          # Fail if debug code is present
          if grep -rn "breakpoint()" src/ tests/ --include="*.py"; then
            echo "‚ùå Found breakpoint() calls"
            exit 1
          fi
          if grep -rn "import pdb" src/ tests/ --include="*.py"; then
            echo "‚ùå Found pdb imports"
            exit 1
          fi
          if grep -rn "print(" src/spectra/ --include="*.py" | grep -v "# noqa"; then
            echo "‚ö†Ô∏è Warning: Found print() statements (consider using logging)"
          fi
          echo "‚úÖ No debug code found"

      - name: üìã Check Commit Messages
        if: github.event_name == 'pull_request'
        run: |
          # Check conventional commits format (optional warning)
          git log --oneline origin/main..HEAD | while read line; do
            if ! echo "$line" | grep -qE "^[a-f0-9]+ (feat|fix|docs|style|refactor|test|chore|build|ci|perf|revert)(\(.+\))?: .+"; then
              echo "‚ö†Ô∏è Non-conventional commit: $line"
            fi
          done
          echo "‚úÖ Commit message check complete"

      - name: üìÅ Check File Permissions
        run: |
          # Ensure no executable Python files
          find src tests -name "*.py" -executable -type f | while read f; do
            echo "‚ùå Executable Python file: $f"
            exit 1
          done
          echo "‚úÖ File permissions OK"

  # ============================================================================
  # Code Quality
  # ============================================================================
  lint:
    name: üßπ Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_PRIMARY }}
          cache: 'pip'

      - name: üì¶ Install Dependencies
        run: pip install -e ".[dev]"

      - name: üîç Ruff Lint
        run: ruff check src/ tests/ --output-format=github

      - name: üîç Ruff Format Check
        run: ruff format --check src/ tests/

      # Note: Black check removed - ruff format is the primary formatter
      # Both tools have similar functionality, ruff is faster and more integrated

  typecheck:
    name: üè∑Ô∏è Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_PRIMARY }}
          cache: 'pip'

      - name: üì¶ Install Dependencies
        run: pip install -e ".[dev]"

      - name: üîç MyPy
        run: mypy --pretty

  # ============================================================================
  # Security
  # ============================================================================
  security:
    name: üîí Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_PRIMARY }}
          cache: 'pip'

      - name: üì¶ Install Dependencies
        run: pip install -e ".[dev]" bandit safety pip-audit

      - name: üîç Bandit Security Scan
        run: bandit -r src/spectra/ -ll -ii -x "*/tests/*"
        continue-on-error: true

      - name: üîç Pip Audit
        run: pip-audit --strict --desc
        continue-on-error: true

      - name: üîç Check for Secrets
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified
        continue-on-error: true

  # ============================================================================
  # Unit Tests (Matrix)
  # ============================================================================
  test:
    name: üß™ Test (Python ${{ matrix.python-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.10', '3.11', '3.12']
        exclude:
          # Reduce matrix size - only test all Python versions on Ubuntu
          - os: macos-latest
            python-version: '3.10'
          - os: windows-latest
            python-version: '3.10'
    steps:
      - uses: actions/checkout@v4

      - name: üêç Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: üì¶ Install Dependencies
        run: pip install -e ".[dev,async]" pytest-timeout

      - name: üß™ Run Tests
        run: pytest tests/ -v --tb=short --ignore=tests/benchmarks/ --timeout=60 --junitxml=test-results-${{ matrix.os }}-${{ matrix.python-version }}.xml

      - name: üì§ Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.os }}-${{ matrix.python-version }}
          path: test-results-*.xml

  # ============================================================================
  # Coverage
  # ============================================================================
  coverage:
    name: üìä Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_PRIMARY }}
          cache: 'pip'

      - name: üì¶ Install Dependencies
        run: pip install -e ".[dev,async]" pytest-timeout

      - name: üß™ Run Tests with Coverage
        run: |
          pytest tests/ \
            --ignore=tests/benchmarks/ \
            --timeout=60 \
            --cov=src/spectra \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-fail-under=70

      - name: üì§ Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/

      - name: üìä Coverage Comment
        if: github.event_name == 'pull_request'
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MINIMUM_GREEN: 80
          MINIMUM_ORANGE: 60

  # ============================================================================
  # Integration Tests
  # ============================================================================
  integration:
    name: üîó Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_PRIMARY }}
          cache: 'pip'

      - name: üì¶ Install Dependencies
        run: pip install -e ".[dev,async]"

      - name: üîó Run Integration Tests
        run: pytest tests/integration/ -v --tb=short -m "not slow"

  # ============================================================================
  # Property-Based Tests
  # ============================================================================
  property-tests:
    name: üé≤ Property Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_PRIMARY }}
          cache: 'pip'

      - name: üì¶ Install Dependencies
        run: pip install -e ".[dev]"

      - name: üé≤ Run Property Tests
        run: pytest tests/property/ -v --hypothesis-show-statistics

  # ============================================================================
  # Build Verification
  # ============================================================================
  build:
    name: üì¶ Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_PRIMARY }}

      - name: üì¶ Install Build Tools
        run: pip install build twine

      - name: üèóÔ∏è Build Package
        run: python -m build --outdir build-dist/

      - name: ‚úÖ Verify Package
        run: twine check build-dist/*

      - name: üì§ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: build-dist/

      - name: üß™ Test Installation
        run: |
          pip install build-dist/*.whl
          spectra --help
          spectra --version

  # ============================================================================
  # Docker Build
  # ============================================================================
  docker:
    name: üê≥ Docker Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üèóÔ∏è Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: dist/docker/Dockerfile
          push: false
          load: true
          tags: spectra:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: üß™ Test Docker Image
        run: |
          docker run --rm spectra:test --help
          docker run --rm spectra:test --version

  # ============================================================================
  # Documentation Build
  # ============================================================================
  docs:
    name: üìö Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: üì¶ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: docs/package-lock.json

      - name: üì¶ Install Dependencies
        working-directory: docs
        run: npm ci

      - name: üîç Lint Markdown
        run: |
          npm install -g markdownlint-cli
          markdownlint "**/*.md" --ignore node_modules --ignore docs/node_modules || true

      - name: üèóÔ∏è Build Documentation
        working-directory: docs
        run: npm run build

      - name: üîç Check for Broken Links
        working-directory: docs
        run: |
          npm install -g broken-link-checker
          # Start local server and check links (optional, can be slow)
          # npx serve .vitepress/dist &
          # sleep 5
          # blc http://localhost:3000 -ro
        continue-on-error: true

  # ============================================================================
  # VS Code Extension
  # ============================================================================
  vscode-extension:
    name: üÜö VS Code Extension
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: integrations/vscode
    steps:
      - uses: actions/checkout@v4

      - name: üì¶ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üì¶ Install Dependencies
        run: npm ci

      - name: üîç Lint
        run: npm run lint || true

      - name: üèóÔ∏è Build
        run: npm run compile

      - name: üì¶ Package
        run: npx vsce package --no-dependencies

  # ============================================================================
  # API Compatibility (for breaking changes)
  # ============================================================================
  api-compat:
    name: üîÑ API Compatibility
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_PRIMARY }}
          cache: 'pip'

      - name: üì¶ Install Dependencies
        run: pip install -e ".[dev]" griffe

      - name: üîç Check API Changes
        run: |
          # Generate API signature for current branch
          griffe dump src/spectra -o api-current.json
          
          # Get main branch API (if exists)
          git checkout origin/main -- . 2>/dev/null || exit 0
          pip install -e ".[dev]"
          griffe dump src/spectra -o api-main.json 2>/dev/null || exit 0
          
          # Compare (informational only)
          echo "üìã API changes detected (review required for breaking changes)"
        continue-on-error: true

  # ============================================================================
  # Size Check
  # ============================================================================
  size-check:
    name: üìè Size Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_PRIMARY }}

      - name: üì¶ Build Package
        run: |
          pip install build
          python -m build

      - name: üìè Check Package Size
        run: |
          WHEEL=$(ls dist/*.whl)
          SIZE=$(stat -f%z "$WHEEL" 2>/dev/null || stat -c%s "$WHEEL")
          SIZE_MB=$(echo "scale=2; $SIZE / 1048576" | bc)
          
          echo "üì¶ Package size: ${SIZE_MB} MB"
          
          # Warn if package is too large (> 5MB)
          if [ $(echo "$SIZE_MB > 5" | bc) -eq 1 ]; then
            echo "‚ö†Ô∏è Warning: Package is larger than 5MB"
          fi

  # ============================================================================
  # Benchmark Regression Check
  # ============================================================================
  benchmark:
    name: ‚ö° Benchmark
    runs-on: ubuntu-latest
    # Only run on PRs with performance label or perf changes
    if: |
      github.event_name == 'pull_request' && (
        contains(github.event.pull_request.labels.*.name, 'performance') ||
        contains(github.event.pull_request.title, 'perf')
      )
    steps:
      - name: üì• Checkout PR
        uses: actions/checkout@v4

      - name: üì• Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          path: main-branch

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_PRIMARY }}
          cache: 'pip'

      - name: üì¶ Install Dependencies (PR)
        run: pip install -e ".[dev]"

      - name: ‚ö° Run Benchmarks (PR)
        run: |
          pytest tests/benchmarks/ \
            --benchmark-only \
            --benchmark-json=pr-benchmark.json \
            --benchmark-min-rounds=5 \
            -q || true

      - name: üì¶ Install Dependencies (main)
        working-directory: main-branch
        run: pip install -e ".[dev]"

      - name: ‚ö° Run Benchmarks (main)
        working-directory: main-branch
        run: |
          pytest tests/benchmarks/ \
            --benchmark-only \
            --benchmark-json=../main-benchmark.json \
            --benchmark-min-rounds=5 \
            -q || true

      - name: üìä Compare Benchmarks
        uses: benchmark-action/github-action-benchmark@v1
        with:
          tool: pytest
          output-file-path: pr-benchmark.json
          external-data-json-path: main-benchmark.json
          fail-on-alert: false
          alert-threshold: "150%"
          comment-on-alert: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-always: true
          summary-always: true

  # ============================================================================
  # Final Status Check (Required for branch protection)
  # ============================================================================
  status-check:
    name: ‚úÖ Status Check
    needs:
      - quick-checks
      - lint
      - typecheck
      - security
      - test
      - coverage
      - integration
      - property-tests
      - build
      - docker
      - docs
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: üìã Check All Jobs
        run: |
          echo "## PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quick Checks | ${{ needs.quick-checks.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check | ${{ needs.typecheck.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result == 'success' && '‚úÖ' || '‚ö†Ô∏è' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.test.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${{ needs.coverage.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration | ${{ needs.integration.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Property Tests | ${{ needs.property-tests.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker | ${{ needs.docker.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docs | ${{ needs.docs.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY

      - name: ‚ùå Fail if Required Checks Failed
        if: |
          needs.quick-checks.result != 'success' ||
          needs.lint.result != 'success' ||
          needs.typecheck.result != 'success' ||
          needs.test.result != 'success' ||
          needs.coverage.result != 'success' ||
          needs.build.result != 'success'
        run: |
          echo "‚ùå One or more required checks failed"
          exit 1

      - name: ‚úÖ All Checks Passed
        run: echo "‚úÖ All required checks passed!"


