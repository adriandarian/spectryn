name: CI

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review, edited]
  # pull_request_target is needed for PR title validation to access PR metadata
  # This is safe because pr-title job does NOT checkout any code
  pull_request_target:
    branches: [main]
    types: [opened, edited, reopened]
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# Detect if this is a dependabot PR to run lighter CI
env:
  IS_DEPENDABOT: ${{ github.actor == 'dependabot[bot]' }}

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # ============================================================================
  # Dependabot: Minimal CI (lint + single test run only)
  # ============================================================================
  dependabot-ci:
    name: ü§ñ Dependabot CI
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
      - run: pip install -e ".[dev]"
      - name: Lint
        run: ruff check src/ tests/
      - name: Type Check
        run: mypy --pretty
      - name: Quick Test
        run: pytest tests/ --ignore=tests/integration/ --ignore=tests/property/ -x -q --timeout=30

  # ============================================================================
  # Stage 1: Fast Feedback (runs immediately) - Skip for dependabot
  # ============================================================================
  pr-title:
    name: üìù PR Title
    runs-on: ubuntu-latest
    # Only run on pull_request_target to have access to PR metadata
    if: github.event_name == 'pull_request_target'
    permissions:
      pull-requests: read
    steps:
      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
            deps
          scopes: |
            core
            adapters
            cli
            application
            plugins
            docs
            tests
            ci
            deps
            vscode
            github-action
            config
          requireScope: false
          ignoreLabels: |
            dependencies
            automated
          wip: true
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            The subject "{subject}" doesn't match the required format.

            ‚ùå Your PR title: "{title}"

            ‚úÖ Expected format: <type>(<scope>): <lowercase description>

            Examples:
              ‚Ä¢ feat: add new sync command
              ‚Ä¢ fix(cli): resolve argument parsing issue
              ‚Ä¢ docs(readme): update installation instructions
              ‚Ä¢ ci: improve test coverage

            Valid types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert, deps
            Valid scopes (optional): core, adapters, cli, application, plugins, docs, tests, ci, deps, vscode, github-action, config

  lint:
    name: üßπ Lint & Format
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - run: pip install -e ".[dev]"
      - name: Ruff Lint
        run: ruff check src/ tests/ --output-format=github
      - name: Ruff Format
        run: ruff format --check src/ tests/

  typecheck:
    name: üè∑Ô∏è Type Check
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - run: pip install -e ".[dev]"
      - run: mypy --pretty

  # ============================================================================
  # Stage 2: Tests (after lint passes - no point testing broken code)
  # Skip for dependabot - they use the lightweight dependabot-ci job
  # ============================================================================
  test:
    name: üß™ Test (py${{ matrix.python-version }}, ${{ matrix.os }})
    needs: [lint, typecheck]
    if: github.actor != 'dependabot[bot]'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ['3.11', '3.12', '3.13']
        include:
          # Only test primary Python version on other OSes
          - os: macos-latest
            python-version: '3.11'
          - os: windows-latest
            python-version: '3.11'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      - run: pip install -e ".[dev,async]" pytest-timeout

      # Run tests with coverage only on ubuntu + primary Python
      # Heavy tests (slow, stress, chaos, e2e, benchmark) are skipped via pyproject.toml
      - name: Run Tests with Coverage
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        run: |
          pytest tests/ \
            --ignore=tests/integration/ \
            --ignore=tests/property/ \
            --timeout=60 \
            --cov=src/spectryn \
            --cov-report=xml \
            --cov-report=html \
            --cov-fail-under=65

      # Run tests without coverage on other matrix combinations
      # Heavy tests (slow, stress, chaos, e2e, benchmark) are skipped via pyproject.toml
      - name: Run Tests
        if: matrix.os != 'ubuntu-latest' || matrix.python-version != '3.11'
        run: pytest tests/ -v --tb=short --ignore=tests/integration/ --ignore=tests/property/ --timeout=60

      - name: Upload Coverage
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/

      - name: Coverage Summary
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        run: |
          echo "## üìä Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          # Extract coverage percentage from the XML report
          if [ -f coverage.xml ]; then
            COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); print(f\"{float(tree.getroot().attrib['line-rate']) * 100:.1f}%\")")
            echo "**Line Coverage:** $COVERAGE" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìÅ Full coverage report available in workflow artifacts" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Stage 3: Additional Tests (after primary tests pass)
  # Skip for dependabot
  # ============================================================================
  integration:
    name: üîó Integration Tests
    needs: [test]
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - run: pip install -e ".[dev,async]"
      - run: pytest tests/integration/ -v --tb=short -m "not slow"

  property-tests:
    name: üé≤ Property Tests
    needs: [test]
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - run: pip install -e ".[dev]"
      - run: pytest tests/property/ -v --hypothesis-show-statistics

  # ============================================================================
  # Stage 3: Build & Package (parallel with additional tests)
  # Skip for dependabot
  # ============================================================================
  build:
    name: üì¶ Build
    needs: [lint, typecheck]
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install build twine
      - run: python -m build
      - run: twine check dist/*.whl dist/*.tar.gz
      - name: Test Installation
        run: |
          pip install dist/*.whl
          spectryn --help
          spectryn --version
      - uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  docker:
    name: üê≥ Docker
    needs: [lint]
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/build-push-action@v5
        with:
          context: .
          file: packaging/docker/Dockerfile
          push: false
          load: true
          tags: spectryn:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: Test Docker Image
        run: |
          docker run --rm spectryn:test --help
          docker run --rm spectryn:test --version

  docs:
    name: üìö Docs
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: docs/package-lock.json
      - working-directory: docs
        run: npm ci
      - working-directory: docs
        run: npm run build

  vscode-extension:
    name: üÜö VS Code Extension
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: integrations/vscode
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - run: npm ci
      - run: npm run lint || true
      - run: npm run compile
      - run: npx vsce package --no-dependencies

  # ============================================================================
  # Security (runs in parallel, informational) - Skip for dependabot
  # ============================================================================
  security:
    name: üîí Security
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]'
    # Security checks are informational - don't block PRs
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - run: pip install -e ".[dev]" bandit pip-audit
      - name: Bandit
        run: bandit -r src/spectryn/ -ll -ii -x "*/tests/*" || echo "Bandit found issues (non-blocking)"
      - name: Pip Audit
        run: pip-audit --desc || echo "Pip audit found issues (non-blocking)"

  # ============================================================================
  # PR Management (runs in parallel)
  # ============================================================================
  auto-assign:
    name: üë• Auto Assign
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && !github.event.pull_request.draft && github.actor != 'dependabot[bot]'
    permissions:
      pull-requests: write
    steps:
      - uses: kentaro-m/auto-assign-action@v2.0.0
        with:
          configuration-path: ".github/auto-assign.yml"
      - uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const author = pr.user.login;

            // Skip if author is a bot or PR already has assignees
            if (author.includes('[bot]')) {
              console.log('Skipping: author is a bot');
              return;
            }

            if (pr.assignees && pr.assignees.length > 0) {
              console.log('Skipping: PR already has assignees:', pr.assignees.map(a => a.login));
              return;
            }

            console.log(`Assigning ${author} to PR #${pr.number}`);
            await github.rest.issues.addAssignees({
              ...context.repo,
              issue_number: pr.number,
              assignees: [author]
            });

  labeler:
    name: üè∑Ô∏è Labels
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/labeler@v5
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          configuration-path: .github/labeler.yml
          sync-labels: true
      - uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: "size/XS"
          xs_max_size: 10
          s_label: "size/S"
          s_max_size: 100
          m_label: "size/M"
          m_max_size: 500
          l_label: "size/L"
          l_max_size: 1000
          xl_label: "size/XL"
          fail_if_xl: false
          files_to_ignore: |
            "*.lock"
            "*.md"
            "package-lock.json"
            "CHANGELOG.md"

  # ============================================================================
  # Final Status Check (Required for branch protection)
  # For dependabot: only depends on dependabot-ci
  # For others: depends on full CI pipeline
  # ============================================================================
  status-check:
    name: ‚úÖ Status Check
    needs: [dependabot-ci, lint, typecheck, test, build]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check Dependabot CI
        if: github.actor == 'dependabot[bot]'
        run: |
          echo "## Dependabot PR Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependabot CI | ${{ needs.dependabot-ci.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.dependabot-ci.result }}" != "success" ]]; then
            exit 1
          fi

      - name: Check Required Jobs
        if: github.actor != 'dependabot[bot]'
        run: |
          echo "## PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check | ${{ needs.typecheck.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if Required Checks Failed
        if: |
          github.actor != 'dependabot[bot]' && (
            needs.lint.result != 'success' ||
            needs.typecheck.result != 'success' ||
            needs.test.result != 'success' ||
            needs.build.result != 'success'
          )
        run: exit 1


