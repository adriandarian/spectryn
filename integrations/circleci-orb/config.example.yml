# Example CircleCI config using Spectra orb
# Copy to your repository as .circleci/config.yml

version: 2.1

orbs:
  spectryn: spectryn/spectryn@1.0.0

# Workflow definitions
workflows:
  # Main workflow for all branches
  main:
    jobs:
      # Always validate markdown
      - spectryn/validate:
          name: validate
          markdown-file: docs/user-stories.md

      # Preview changes on feature branches
      - spectryn/sync:
          name: preview
          markdown-file: docs/user-stories.md
          epic-key: ${EPIC_KEY}
          dry-run: true
          verbose: true
          requires:
            - validate
          filters:
            branches:
              ignore: main
          context: jira-credentials

      # Show diff on feature branches
      - spectryn/diff:
          name: diff
          markdown-file: docs/user-stories.md
          epic-key: ${EPIC_KEY}
          requires:
            - validate
          filters:
            branches:
              ignore: main
          context: jira-credentials

      # Execute sync on main branch
      - spectryn/sync:
          name: deploy
          markdown-file: docs/user-stories.md
          epic-key: ${EPIC_KEY}
          execute: true
          backup: true
          export-results: sync-results.json
          requires:
            - validate
          filters:
            branches:
              only: main
          context: jira-credentials

  # Nightly incremental sync
  nightly-sync:
    triggers:
      - schedule:
          cron: "0 6 * * 1-5"  # 6 AM weekdays
          filters:
            branches:
              only: main
    jobs:
      - spectryn/sync:
          name: incremental-sync
          markdown-file: docs/user-stories.md
          epic-key: ${EPIC_KEY}
          incremental: true
          execute: true
          context: jira-credentials

  # Weekly pull from Jira
  weekly-pull:
    triggers:
      - schedule:
          cron: "0 0 * * 0"  # Sunday midnight
          filters:
            branches:
              only: main
    jobs:
      - spectryn/pull:
          name: pull-from-jira
          epic-key: ${EPIC_KEY}
          output-file: docs/imported-stories.md
          context: jira-credentials

# Alternative: Using commands directly for more control
# workflows:
#   custom:
#     jobs:
#       - custom-sync
#
# jobs:
#   custom-sync:
#     executor: spectryn/python
#     steps:
#       - checkout
#       - spectryn/install:
#           version: "1.0.0"
#       - spectryn/validate-command:
#           markdown-file: docs/user-stories.md
#       - spectryn/sync-command:
#           markdown-file: docs/user-stories.md
#           epic-key: ${EPIC_KEY}
#           execute: true
#       - store_artifacts:
#           path: backups/
#           destination: backups
